# 第二章：应用层

因特网应用包括：

20世纪70年代和80年代开始流行的经典的**基于文本的应用**，如文本电子邮件，远程访问计算机，文件传输和新闻

20世纪90年代引入万维网，包括Web冲浪，搜索和电子商务。

20世纪末引入即使讯息和P2P文件共享。

2000年以来，视频会议，用户生成视频（YouTube）和点播电影以及多人联机游戏。

## 2.1应用层协议原理

### 2.1.1网络应用程序体系结构

##### 1.客户-服务器体系结构

在这个体系中，一个总是打开的主机称为**主机**，它服务来自许多其它称为**客户**的主机的请求。

以Web应用程序为例，Web服务器服务于来自运行的客户主机上的浏览器的请求，它向客户发送所请求的对象作为响应，

特点：

* 客户之间不能相互通信
* 服务器总是打开的，且服务器具有固定的IP地址

客户-服务器体系结构的应用程序有Web，FTP，Telnet。

![客户-服务器体系结构](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\客户端-服务器体系.jpg)

##### 2. P2P体系结构

应用程序在间断链接的主机对之间使用直接通信，这些主机称为**对等方**，因为这种对等方沟通不必通过专门

的服务器，因此被称为对等方到对等方的。

特点：

* 对等方之间互相通信，提升了系统的服务能力
* 不需要庞大的服务器基础设施

P2P体系结构的应用程序有对等方协助下载器（迅雷），视频会议（SKype）

<img src="C:\课外学习\博客笔记\计算机网络（Top-Down）\img\P2P体系结构.jpg" alt="P2P体系结构" style="zoom:100%;" />

##### 3. 混合模式

某些应用结合客户-服务器和P2P的元素，例如多用户即时通讯系统，服务器被用户跟踪用户的IP地址，但用户

到用户的报文无需通过服务器而是直接在主机之间进行发送。比如QQ，聊天功能是C-S架构的，文件传输的功能使用P2P。

### 2.1.2进程通信

两个不同端系统上的进程，通过计算机网络交换报文而相互通信。

##### 1.客户-服务器进程

对于每对通信的进程，通常将两个进程之一标识为客户，另一个进程标识为服务器。对于Web而言，浏览器是客户进程

Web服务器是服务器进程，对于P2P文件共享，下载的一方标识为客户，上载的一方是服务器，所以在P2P中既能够是

客户，也能是服务器。

##### 2.进程与计算机网络之间的接口

进程通过**套接字（socket）**的软件接口向网络发送报文和接受报文，可以将进程类比为一所房子，套接字类似它的门，

当它向另外一台主机发送报文时，它把报文推出门，而接受进程也通过这扇门接受报文并进行处理。

套接字是应用层与传输层之间的接口，应用程序开发者可以为套接字选择运输层协议（TCP和UDP），那么==应用程序就建立==

==在由该协议提供的运输层服务之上。==

<img src="C:\课外学习\博客笔记\计算机网络（Top-Down）\img\进程通信.jpg" alt="进程通信" style="zoom:80%;" />

##### 3.进程寻址

运行在一台主机上的进程为了向另一台主机上的进程发送分组，接受进程需要一个地址。为了标识接受进程，需要定义两种信息：

①主机的地址 ②目的主机接受进程的标识符。

在因特网中，==主机由IP地址标识==，IP地址是一个32位比特的量，它能够唯一标识主机在互联网上中的位置。==主机上的接受进程==

==由端口号来指定，==比如Web服务器用端口号80来标识，MySQL服务默认用端口号3306来标识。

#### 2.1.3 可供应用程序使用的运输服务

一个运输层协议提供的服务可以从以下四个角度衡量

##### 1. 可靠数据传输服务

如果一个协议能够确保==由应用程序一端发送的数据能够正确，完全的交付给应用程序的另一端==。那么就认为提供了可靠数据传输服务。

而运输层协议不提供可靠数据传输时，这可能被一些应用接受，比如多媒体应用。

##### 2.吞吐量

运输层协议能够以某种特定的速率提供确保的吞吐量。使用这种的服务应用程序能够确保请求 ***r*** 比特/秒的确保吞吐量。具有吞吐量

要求的应用被称为具有**带宽敏感的应用**，比如说互联网电话应用程序，要求语音以***32 kbps***的速率进行编码而根据带宽或多或少的

利用可供使用的吞吐量则是**弹性应用**。

##### 3.定时

运输层协议也能够提供定时保证，比如发送方进入套接字到每个比特到达接受方的套接字不迟于100 ms。这种服务对交互式

实时应用程序有吸引力。如电话会议，联机游戏等。所有这些服务==为了有效性而要求数据交付有严格的时间限制==。

##### 4.安全性

运输协议能够提供安全性服务，以防数据以某种方式在两个经常之间被观察到例如运输协议能够加密发送进程传输的多有数据，

在接受主机中，运输层协议能够将数据交付给接收进程之前解密这些数据。

#### 2.1.4因特网提供的运输服务

因特网为应用程序提供两个运输层协议，**TCP**和**UDP**

##### 1. TCP服务

TCP服务模型包括面向连接的服务和可靠数据传输服务。

- 面向连接的服务：在应用层数据报文开始流动之前，**TCP**让客户端和服务器互相交换运输层控制信息，经历三次握手后

  一个**TCP连接**就在两个进程之间的套接字建立起来了，应用程序结束时，必须拆除该连接。

- 可靠的数据传输服务：通信进程能够依靠TCP，无差错，按适当顺序交付所有发送的数据。

TCP还有拥塞控制协议，当发送方和接收方之间的网络出现拥塞时，**TCP**的拥塞控制机制会一直发送进程，==它试图限制每个==

==TCP连接，使他们达到公平共享网络带宽的目的。==

##### 2. UDP服务

UDP是一种不提供不必要服务的轻量级运输协议，它是无连接的，在进程通信前没有握手过程，UDP协议提供不可靠数据

数据传输服务，也没有拥塞控制机制。

##### 3.因特网运输协议不提供的服务

TCP提供了可靠的端到端数据传输服务，在应用层能通过*SSL*来加强以提供安全服务，但是没有涉及到吞吐量和定时的服务。

目前的因特网运输协议不能提供吞吐量和定时保证的服务，但是==它们已经被设计的最大可能对付这种保证==，即因特网能

为时间敏感应用提供满意的服务，但是它不能提供任何保证。

| 应用         | 应用层协议 | 运输协议 |
| ------------ | ---------- | -------- |
| 电子邮件     | SMTP       | TCP      |
| 远程中断访问 | Telnet     | TCP      |
| Web          | HTTP       | TCP      |
| 文件传输     | FTP        | TCP      |
| 流式多媒体   | HTTP       | TCP      |
| 因特网电话   | SIT、RTP   | UDP/TCP  |

#### 2.1.5 应用层协议

==应用层协议定义了运行在不同端系统上的应用程序如何相互传递报文==，特别是应用层协议定义了

* 交换的报文类型，如请求报文和响应报文。
* 报文类型的语法，如报文中应该有哪些字段并是如何描述的。
* 字段的语义，字段中信息的含义。
* 确定一个进程何时以及如何发送报文，对报文进行响应的规则。

网络应用和应用层协议的区分：应用层协议只是网络应用的一部分，比如Web应用，包括**文档格式（HTML）**,**Web服务器（Apache服务器）**

**Web浏览器（Firefox）**以及**应用层协议（HTTP）**。HTTP定义了浏览器和Web服务器之间传输的报文格式和序列。

### 2.2 Web和HTTP

#### 2.2.1 概况

**Web页面**是由对象组成的，一个对象只是一个文件，比如一个**HTML**文件，一个**JPEG**图像，一个视频片段。它们通过一个**URL**地址寻址，

每一个**URL**地址由两部分组成，存放对象的主机名和路径名。

**Web**的应用层协议是**超文本传输协议（HyperText Transfer Protocol，HTTP）**。**HTTP**使用TCP作为它的支撑运输协议，**HTTP**客户首先

发送一个与服务器的TCP连接，一旦连接建立，该浏览器和服务器进程就可通过套接字接口访问TCP。服务器向客户发送被请求的文件，而

不存储任何关于该客户的状态信息，所以HTTP是一个**无状态协议**

#### 2.2.2 非持续性连接和持续连接

在客户和服务器进行通信的过程中，每个请求/响应对可以是一个单独的TCP连接发送也可以是所有请求都经相同的TCP发送，采用前者的

应用程序称为使用**非持续连接**和后者称为使用**持续连接**。

##### 1.采用非持续连接的HTTP

以服务器向客户传送一个包含一个HTML文件和是个JPEG图像的Web页面为例，整个过程如下

1）HTTP客户进程向服务器发起一个TCP连接。

2）HTTP客户经过套接字向服务器发送一个HTTP请求报文。

3）HTTP服务器经过套接字接收请求报文，从存储器中找出该对象，在一个HTTP响应报文中封装该对象，

并通过套接字向客户端发送响应报文。

==4）HTTP服务器进程通知服务器断开TCP连接（知道客户完全接受到响应报文才会世纪中断连接）==

5）HTTP客户端接受响应报文，连接关闭。客户从响应报文提取除文件，==检查HTML文件，发现了10个对JPEG==

==图像的引用，于是再次建立TCP连接==重复前四个步骤。

![](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\非持续连接.jpg)

总的响应时间是两个**RTT（往返时间）**加上传输文件的时间。

##### 2.采用持续连接的HTTP

非持续连接的缺点：第一，必须为每一个请求的对象建立和维护一个TCP连接，给Web服务器带来了负担；第二：每一个对象

的时延是两倍往返时间加上文件传输的时间。

采用持续连接的情况下，后续的请求和响应报文能够通过相同的连接进行传送，特别是==一个完整的Web页面可以用单个持续==

==TCP连接进行传送==。甚至位于==同一台服务器的多个Web页面都可以通过单个持续的TCP连接发送给同一个客户==。对对象的请求可以

一个个发出而不必等待对未决请求的回答。

#### 2.2.3 HTTP报文格式

##### 1. HTTP请求报文

以下面一个典型的HTTP请求报文为例：

> GET /somedir/page.heml	HTTP/1.1
>
> Host:	www.someschool.edu
>
> Connection:	close
>
> User-agent:	Mozilla/5.0
>
> Accept-language:	fr

* 第一行是请求行，有三个字段：方法字段、URL字段和HTTP版本字段，方法字段除了是**GET**外还可以是**POST**,**HEAD**，**PUT**和**DELETE**。

* 之后几行是首部行，
  * **Host** 指明了对象所在的主机
  * **Connection** ，close告诉浏览器不要使用持续连接而是再服务器发送完被请求的对象就关闭该连接
  * **User-agent**，指明用户代理，即发送请求的服务器类型
  * **Accept-language**，用户想要获取的语言版本

![](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\HTTP通用请求报文格式.jpg)

在首部行行后由一个**Entity body**（实体体），使用**GET**方法时，这一部分为空，当使用**POST**方式，比如向搜索引擎提供搜索关键词

实体体包含的是用户输入的表单字段中的值。但是用表单生成的请求报文不是必须使用**POST**方法，可以在**URL**中包括输入的数据，

比如在百度（***https://www.baidu.com***）的搜索框中输入计算机网络，得到的是(**https://cn.bing.com/search?q=计算机网络**)

**(实际搜到的网页比这个更复杂)**。

##### 2. HTTP响应报文

以下面的典型响应报文为例

> **HTTP**/1.1 200 OK
>
> Connection: close Date: Tue, 18 Aug 2015 15: 44 :04 GMT 
>
> Server: Apache/2.2.3 (CentOS) 
>
> Last-Modified: Tue, 18 Aug 2015 15: 11: 03 GMT 
>
> Content-Length: 6821 
>
> Content-Type: text/html 
>
> (data data data data data ...)

* 第一行是请求行，有三个字段：协议版本字段，状态码，状态信息
* 之后几行是首部行，
  * **Last-Modified**：对象创建的最后修改时期。
  * **Content-Length** ，被发送对象的字节数。
  * **Content-Type**，实体体的对象是是**HTML**文本。

关于状态码：

* **200 OK**：请求成功。
* **301 Moved Permanently** 请求的对象被转移，新的**URL**在响应报文中的首部行**Location：**
* **400 Bad Request**：请求不能被服务器理解。
* **404 Not Find**：请求的内容不在服务器上。

#### 2.2.4 用户与服务器的交互：Cookie

HTTP服务是无状态的，但是一个Web站点常常希望能够识别用户，它希望能够把网页的内容与用户联系起来，于是HTTP采用了**cookie**。

**cookie**有四个组件：

1. 在HTTP响应报文中有一个cookie首部行。
2. 在HTTP请求报文中有一个cookie首部行。
3. ==在客户端系统保留一个cookie文件，并由用户的浏览器进行管理。==
4. ==位于Web站点的一个后端数据库。==

cookie的工作过程如下图所示：

![](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\Cookie.jpg)

#### 2.2.5 Web缓存

Web缓存也叫代理服务器，它能够代表初始Web服务器来满足HTTP请求的网络实体。工作原理如图所示

![](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\Web缓存.jpg)

注意：==缓存服务器如果没有请求的对象，会先向初始服务器请求对象，在本地保存副本后再发送给用户。而不是由客户访问初始服务器。==

使用Web缓存服务可以带来以下好处

* 减少客户请求的响应时间，如客户与缓存服务器之间通常是一个高速连接，这比访问初始服务器快很多。
* 从整体上大大减少了Web流量，降低了费用

#### 2.2.6 条件GET

Web缓存也带来了一个新的问题：如果被请求的对象在初始服务器已经被更新了，那么客户请求的缓存器中的对象是陈旧的。于是HTTP引入

一种机制，允许缓存器证明它的对象是最新的，这种机制是条件GET方法。通过在请求报文种增加一个**If-Modified-Since：**首部行来实现。

例如：

当一个用户向Web缓存器请求一个对象时，缓存器向Web服务器发送一个条件GET请求报文，**If-Modified-Since：**中的内容是对象最后一次

更新时间，如果服务器中的对象在这个时间之后更新过才会发送对象。否则会在响应报文中包含一个状态码：**304 Not Modified**，它告诉

缓存器可以向用户浏览器发送它所存储的对象副本。

### 2.3 电子邮件

电子邮件系统由三个主要组成部分：**用户代理**，**邮件服务器**，**邮件传输协议**。

##### 1.用户代理

用户代理（网易邮箱，GMail）允许用户阅读，回复、转发和保存。当用户写完一份邮件选送发送给对方时，由邮件代理服务器向服务器发送，此时邮件存放在

邮件服务器的外出报文队列中。当接受方要查看邮件时，也是由用户代理在邮件服务器的邮箱中取出报文。

##### 2.邮件服务器

邮件服务器时电子邮件系统的核心，每一个用户都在某个邮件服务器上有一个邮箱，邮箱管理和维护发送给他的报文。

一个典型的邮件发送过程：从发送方的用户代理开始，传送到发送方的服务器，再传输到对方的邮件服务器，然后在这里的服务器本分发到接收方的邮箱中

##### 3.邮件传输协议

**SMTP**是电子邮件中主要的应用层协议，使用**TCP**可靠的数据传输服务。

#### 2.3.1 SMTP

SMTP限制邮件报文的体部分采用7比特的ASCII来表示，因此在用SMTP发送文件之前，需要将二进制多媒体数据编码为ASCII码，传输完成后还需要解码

使用SMTP进行邮件传输的过程如下

![](C:\课外学习\博客笔记\计算机网络（Top-Down）\img\SMTP.jpg)

==注意：SMTP连接建立在双方的邮件服务器之间。==

### 2.4 因特网的目录服务：DNS

在互联网上的主机由两种标识方式，一种是主机名，如 ***www.google.com***，但是主机名对机器来说不好处理，第二种是**IP**地址，它能够很简单的被机器所

识别，当我们向要访问Web服务器时，我们熟悉主机名，但是如何给机器**IP**呢？于是出现了一种主机名到IP地址转换的服务，这就是域名系统**DNS**。

更具体的说，**DNS**是一个由分层的分布式数据库，一个能够使得主机能够查询分布式数据库的应用层协议，==DNS协议运行在UDP上，使用53号端口。==

##### 2.4.1 DNS提供的服务

DNS服务器通常是由其它应用层协议使用到的，它能够将用户提供的主机名解析为IP地址。通常这个IP地址缓存在附近的DNS服务器中。

除了域名解析服务，DNS还提供一些其它服务。

* 获得主机别名对应的规范主机名。

* 邮件服务器别名，DNS能够对提供的电子邮件地址进行解析。

* **负载分配**：一些繁忙的站点被冗余的分布在多台服务器上，这些服务器的地址集合与同一个规范主机名联系，DNS数据库中存储这些IP地址集合

  当客户对对这个主机名发送DNS请求时，服务器用整个IP地址集合进行响应，所以DNS就在所有这些Web服务器之间循环分配了负载。

### 2.5 P2P文件分发

P2P文件分发通常应用**大文件的分发**，在客户-服务器模式中，服务器承受了极大的负担，但是在P2P文件分发中，==每个对等方能够向任何其它对等方==

==重新分发已经收到的该文件的任何部分==，从而在分发过程中协助服务器。

#### 2.5.1 P2P的分发时间

如图所示 $$u_s$$ 表示服务器接入链路的上载速率，$$u_i$$ 和 $$d_i$$ 表示对等方的上载和下载速率， $$F$$ 表示文件的长度， $$N$$ 表示对等方的数量。

定义**分发时间**为==所有 $$N$$ 个对等方得到该未年检的副本所需要的时间==。

##### 1. 客户-服务器模式的分发时间

* 服务器向$$N$$个对等方传输一个副本。
* 最小下载速率的对等方限制了分发时间。

由以上两点，分发时间应该为：
$$
D_{cs} \ge \{\frac {NF}{u_s},\frac F{d_{min}}\}
$$

##### 2. P2P模式的分发时间

* 服务器至少发送一个完整的文件一次
* 最小下载速率的限制
* 系统总的上载能力等于服务器的上载速率加上每个单独的对等方的上载速率

由以上三点，分发时间应该为：
$$
D_{cs} \ge \{\frac {F}{u_s},\frac F{d_{min}},\frac {NF}{u_s + \sum_{i=1}^Nu_i}\}
$$

#### 2.5.2 BitTorrent

**BitTorrent**是一种是一种用于文件分发的流行P2P协议，以下上一些关于该协议的重要概念：

* **torrent（洪流）**：参与一个特定文件分发的所有对等方的集合被称为一个洪流。
* **chunk（文件快）**：在一个洪流中的对等方彼此下载等长度的文件快。典型的块长度为256 *KB*.

* **tracker（追踪器）**：一个洪流中的基础设施节点，当一个对等方加入时，它向追踪器注册自己，并周期性通知追踪器自己仍在洪流中。

* **临近对等方**：当一个新的对等方*Alice*加入洪流时，追踪器随机选择参与文件分发的对等方并把它们的地址发送给*Alice*，然后*Alice*将与

  这些对等方建立*TCP*连接，这些对等方称为*Alice*的临近对等方。

建立*TCP*连接后，要下载一份完成的文件，要解决两个问题：1.如何知道哪个对等方有哪些文件快。2.从哪些对等方接受块，对哪些对等方发送块

针对第一个问题：*Alice*周期性的询问每个临近对等方它们所具有的块列表，然后对它没有的块发送请求。

针对第二个问题：

1. 接受快采用**最稀缺优先（rarest first）**的技术，最稀缺指的是在它所有的临近对等方副本最少的块

2. 发送块采用对换算法，基本的思想是==优先发送给能够以最高速率下载的对等方==，并且每过一段时间就重新计算速率并且可能修改，

   同时还会随机的选择一个临近对等方发送，如果它的下载速率足够快，就会持续进行连接，否则又会被更换。==其它的临近对等方==

   ==都会被阻塞。==

### 2.6 视频流和内容分发网

视频是一系列的图像，通常以恒定速率来展现，视频的一个重要特征是它能够被压缩，因此可以用比特率来衡量视频质量。

#### 2.6.1 HTTP流和DASH

##### 1.客户与服务器的交互

用户要看视频时，客户与服务器建立*TCP*连接并发送对*URL*的*GET*请求，服务器以尽可能快的速度进行发送，客户接受

到后，==字节被收集到应用程序的缓存中，当缓存的字节数超过了预设定的门限后就开始播放==，在播放过程中继续缓存视频后面的帧。

##### 2. DASH

前面提到过视频的比特率，比特率越高，视频质量越好越清晰但是对带宽的要求就越高。

==这带来一个严重的问题：客户的带宽时有限的，==

那么如何选择合适的比特率进行发送呢？于是有了一种新技术：**经HTTP的动态适应流（DASH）**，在 *DASH* 中视频编码为几个不同的版本，

每个版本对应不同的比特率，==客户能够动态的请求不同版本的视频数据块，并根据带宽做出选择==。

* **告示文件（manifest file）**：为每个版本提供一个URL和比特率。客户首先请求告示文件。
* 速率决定算法：测量带宽并选择下次请求的视频块。

#### 2.6.2 内容分发网

向全世界数百万的用户提供流式传输的视频和高交互是一个巨大的挑战，按照传统的方式：即建立一个单一的大规模数据中心，这带来了三个问题

1. 客户远离数据中心会带来很大的时延。

2. 流行的视频会经过相同的链路发送很多次，浪费了网络带宽并且还要为止支付费用。
3. 单点故障，数据中心崩溃或者链路崩溃，它将不能再分发任何视频。

于是现在所有的视频流分发都采用**内容分发网（Content Distribution Network, CDN）**，*CDN*管理分布在多个地理位置上的服务器，在它的

服务器存储视频的副本，并且试图将所有用户请求定位到一个将提供最好的用户体验的*CDN*位置。

*CDN*采用两种不同的服务器安置原则：

* **深入**，在遍及全球的接入*ISP*中部署服务器来深入到*ISP*的接入网中
* **邀请做客**：在关键位置建造大集群来邀请*ISP*做客，通常反倒因特网交换点（IXP）中。

##### 1. CDN操作

当用户主机中的浏览器指令检索一个特定的视频时，*CDN*必须截获该请求，以便能够①确定此时适合客户的CDN集群，②将客户的请求重定位的集群的服务器

一个完整的请求视频流过程如下：

##### 2.集群选择策略

集群选择策略是动态将客户定向到CDN中的某个服务器集群或数据中心的机制。有以下两种策略

* 地理上临近，使用地理位置数据库，每个*LDNS IP*地址都映射到一个地理位置，CDN选择地理上最接近的集群。
* 实时测量，*CDN*让它的每个集群周期性的向位于全世界的*LDNS*发送探测分组。
